# –ü–ª–∞–Ω –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ RenderContext –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

## –®–∞–≥ 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–∞–Ω–∞–ª–∏–∑ –º–∞—Å—à—Ç–∞–±–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

### –ù–∞–π—Ç–∏ –≤—Å–µ impl DynRenderObject

```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ —Ñ–∞–π–ª—ã —Å impl DynRenderObject
rg "impl.*DynRenderObject" --type rust

# –û–∂–∏–¥–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã:
# - crates/flui_rendering/src/render_flex.rs
# - crates/flui_rendering/src/objects/layout/*.rs
# - crates/flui_rendering/src/objects/visual/*.rs
# - crates/flui_core/src/render/*.rs
```

### –û—Ü–µ–Ω–∫–∞:
- ~10-20 impl –±–ª–æ–∫–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ~50-100 –º–µ—Å—Ç –≥–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è layout/paint
- –í—Ä–µ–º—è: 2-4 —á–∞—Å–∞ —Ä–∞–±–æ—Ç—ã

## –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å RenderContext (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)

**–§–∞–π–ª:** `crates/flui_core/src/render/render_context.rs`

```rust
//! Rendering context for RenderObject operations
//!
//! Provides access to ElementTree and other resources needed during
//! layout and paint operations.

use std::sync::Arc;
use parking_lot::RwLock;

use crate::{ElementId, ElementTree, PipelineOwner};

/// Rendering context passed to RenderObject during layout/paint
///
/// Provides access to:
/// - Element tree for accessing children
/// - Current element ID
/// - Pipeline owner (optional)
///
/// # Example
///
/// ```rust,ignore
/// fn layout(&mut self, constraints: BoxConstraints, ctx: &RenderContext) -> Size {
///     // Access children through tree
///     let element = ctx.tree.read().get(ctx.element_id).unwrap();
///     for child_id in element.children_iter() {
///         let child = ctx.tree.read().get(child_id).unwrap();
///         // Process child...
///     }
/// }
/// ```
#[derive(Clone)]
pub struct RenderContext {
    /// Element tree for accessing children
    tree: Arc<RwLock<ElementTree>>,
    
    /// Current element ID
    element_id: ElementId,
    
    /// Pipeline owner (optional, for scheduling)
    pipeline_owner: Option<Arc<RwLock<PipelineOwner>>>,
}

impl RenderContext {
    /// Create a new render context
    pub fn new(
        tree: Arc<RwLock<ElementTree>>,
        element_id: ElementId,
    ) -> Self {
        Self {
            tree,
            element_id,
            pipeline_owner: None,
        }
    }
    
    /// Create with pipeline owner
    pub fn with_owner(
        tree: Arc<RwLock<ElementTree>>,
        element_id: ElementId,
        pipeline_owner: Arc<RwLock<PipelineOwner>>,
    ) -> Self {
        Self {
            tree,
            element_id,
            pipeline_owner: Some(pipeline_owner),
        }
    }
    
    /// Get the element tree
    #[inline]
    pub fn tree(&self) -> &Arc<RwLock<ElementTree>> {
        &self.tree
    }
    
    /// Get the current element ID
    #[inline]
    pub fn element_id(&self) -> ElementId {
        self.element_id
    }
    
    /// Get the pipeline owner (if available)
    #[inline]
    pub fn pipeline_owner(&self) -> Option<&Arc<RwLock<PipelineOwner>>> {
        self.pipeline_owner.as_ref()
    }
}

impl std::fmt::Debug for RenderContext {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_struct("RenderContext")
            .field("element_id", &self.element_id)
            .field("has_pipeline_owner", &self.pipeline_owner.is_some())
            .finish()
    }
}
```

**–î–æ–±–∞–≤–∏—Ç—å –≤ mod.rs:**

```rust
// crates/flui_core/src/render/mod.rs
mod render_context;
pub use render_context::RenderContext;
```

## –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç—å DynRenderObject trait (breaking change)

**–§–∞–π–ª:** `crates/flui_core/src/render/dyn_render_object.rs`

### 2.1 –ò–∑–º–µ–Ω–∏—Ç—å signature –º–µ—Ç–æ–¥–æ–≤

```rust
pub trait DynRenderObject: DowncastSync + fmt::Debug {
    // ========== –ë–´–õ–û ==========
    // fn layout(&mut self, constraints: BoxConstraints) -> Size;
    // fn paint(&self, painter: &egui::Painter, offset: Offset);
    
    // ========== –°–¢–ê–õ–û ==========
    
    /// Perform layout with rendering context
    fn layout(
        &mut self,
        constraints: BoxConstraints,
        ctx: &RenderContext,
    ) -> Size;
    
    /// Paint this render object with rendering context
    fn paint(
        &self,
        painter: &egui::Painter,
        offset: Offset,
        ctx: &RenderContext,
    );
    
    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
}
```

### 2.2 –û–±–Ω–æ–≤–∏—Ç—å default implementations (–µ—Å–ª–∏ –µ—Å—Ç—å)

–í—Å–µ default impl —Ç–∞–∫–∂–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–Ω–∏–º–∞—Ç—å `ctx`.

## –®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ impl –±–ª–æ–∫–∏ (—Å–∞–º–∞—è –±–æ–ª—å—à–∞—è —Ä–∞–±–æ—Ç–∞)

### –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è leaf render objects (–±–µ–∑ –¥–µ—Ç–µ–π):

```rust
// –ë–´–õ–û:
impl DynRenderObject for RenderText {
    fn layout(&mut self, constraints: BoxConstraints) -> Size {
        // layout logic
        self.size
    }
    
    fn paint(&self, painter: &Painter, offset: Offset) {
        // paint logic
    }
}

// –°–¢–ê–õ–û:
impl DynRenderObject for RenderText {
    fn layout(
        &mut self, 
        constraints: BoxConstraints,
        _ctx: &RenderContext,  // ‚Üê underscore –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º
    ) -> Size {
        // layout logic –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        self.size
    }
    
    fn paint(
        &self, 
        painter: &Painter, 
        offset: Offset,
        _ctx: &RenderContext,  // ‚Üê underscore –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º
    ) {
        // paint logic –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    }
}
```

### –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è single-child render objects:

```rust
// –ë–´–õ–û:
impl DynRenderObject for RenderPadding {
    fn layout(&mut self, constraints: BoxConstraints) -> Size {
        if let Some(child) = &mut self.child {
            let child_constraints = /* compute */;
            child.layout(child_constraints);
            // use child.size()
        }
        self.size
    }
}

// –°–¢–ê–õ–û:
impl DynRenderObject for RenderPadding {
    fn layout(
        &mut self, 
        constraints: BoxConstraints,
        ctx: &RenderContext,
    ) -> Size {
        // –ü–æ–ª—É—á–∞–µ–º child —á–µ—Ä–µ–∑ tree
        let tree = ctx.tree().read();
        let element = tree.get(ctx.element_id()).unwrap();
        
        if let Some(child_id) = element.children_iter().next() {
            let child_elem = tree.get(child_id).unwrap();
            if let Some(child_ro) = child_elem.render_object() {
                let child_size = child_ro.size();
                // use child_size...
            }
        }
        
        self.size
    }
}
```

### –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è multi-child render objects (RenderFlex):

```rust
impl DynRenderObject for RenderFlex {
    fn layout(
        &mut self,
        constraints: BoxConstraints,
        ctx: &RenderContext,
    ) -> Size {
        self.constraints = Some(constraints);
        
        // –ü–æ–ª—É—á–∞–µ–º element –∏ –µ–≥–æ –¥–µ—Ç–µ–π
        let tree = ctx.tree().read();
        let element = tree.get(ctx.element_id()).unwrap();
        
        let mut total_main = 0.0;
        let mut max_cross = 0.0;
        
        // –ò—Ç–µ—Ä–∏—Ä—É–µ–º –¥–µ—Ç–µ–π
        for child_id in element.children_iter() {
            if let Some(child_elem) = tree.get(child_id) {
                if let Some(child_ro) = child_elem.render_object() {
                    let child_size = child_ro.size();
                    
                    match self.direction {
                        Axis::Horizontal => {
                            total_main += child_size.width;
                            max_cross = max_cross.max(child_size.height);
                        }
                        Axis::Vertical => {
                            total_main += child_size.height;
                            max_cross = max_cross.max(child_size.width);
                        }
                    }
                }
            }
        }
        
        // Compute final size
        let size = match self.direction {
            Axis::Horizontal => Size::new(total_main, max_cross),
            Axis::Vertical => Size::new(max_cross, total_main),
        };
        
        self.size = constraints.constrain(size);
        self.needs_layout_flag = false;
        
        self.size
    }
    
    fn paint(
        &self,
        painter: &egui::Painter,
        offset: Offset,
        ctx: &RenderContext,
    ) {
        let tree = ctx.tree().read();
        let element = tree.get(ctx.element_id()).unwrap();
        
        let mut current_offset = offset;
        
        for child_id in element.children_iter() {
            if let Some(child_elem) = tree.get(child_id) {
                if let Some(child_ro) = child_elem.render_object() {
                    // Paint child
                    child_ro.paint(painter, current_offset, ctx);
                    
                    // Update offset
                    match self.direction {
                        Axis::Horizontal => {
                            current_offset.dx += child_ro.size().width;
                        }
                        Axis::Vertical => {
                            current_offset.dy += child_ro.size().height;
                        }
                    }
                }
            }
        }
    }
}
```

## –®–∞–≥ 4: –û–±–Ω–æ–≤–∏—Ç—å PipelineOwner

**–§–∞–π–ª:** `crates/flui_core/src/tree/pipeline.rs`

```rust
impl PipelineOwner {
    pub fn flush_layout(&mut self) {
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ depth (parents –ø–æ—Å–ª–µ children)
        self.nodes_needing_layout.sort_by_key(|id| {
            self.tree.read()
                .get(*id)
                .map(|e| e.depth())
                .unwrap_or(0)
        });
        
        // Layout –∫–∞–∂–¥–æ–≥–æ node
        for element_id in self.nodes_needing_layout.drain(..) {
            self.layout_element(element_id);
        }
    }
    
    fn layout_element(&mut self, element_id: ElementId) {
        // –°–æ–∑–¥–∞—ë–º context
        let ctx = RenderContext::new(
            self.tree.clone(),
            element_id,
        );
        
        // Layout element
        let tree = self.tree.read();
        if let Some(element) = tree.get(element_id) {
            if let Some(mut ro) = element.render_object_mut() {
                let constraints = /* get constraints somehow */;
                ro.layout(constraints, &ctx);
            }
        }
    }
    
    pub fn flush_paint(&mut self, painter: &egui::Painter) {
        for element_id in &self.nodes_needing_paint {
            self.paint_element(*element_id, painter);
        }
        self.nodes_needing_paint.clear();
    }
    
    fn paint_element(&self, element_id: ElementId, painter: &egui::Painter) {
        // –°–æ–∑–¥–∞—ë–º context
        let ctx = RenderContext::new(
            self.tree.clone(),
            element_id,
        );
        
        let tree = self.tree.read();
        if let Some(element) = tree.get(element_id) {
            if let Some(ro) = element.render_object() {
                ro.paint(painter, Offset::zero(), &ctx);
            }
        }
    }
}
```

## –®–∞–≥ 5: –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã

–í—Å–µ —Ç–µ—Å—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç `layout()` –∏–ª–∏ `paint()` –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å:

```rust
// –ë–´–õ–û:
let size = render_object.layout(constraints);

// –°–¢–ê–õ–û:
let tree = Arc::new(RwLock::new(ElementTree::new()));
let element_id = ElementId::new();
let ctx = RenderContext::new(tree, element_id);
let size = render_object.layout(constraints, &ctx);
```

## –®–∞–≥ 6: –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

- README —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º RenderContext
- –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞
- Architecture –¥–æ–∫—É–º–µ–Ω—Ç—ã

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—á—Ç–æ–±—ã –∫–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–ª—Å—è)

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `RenderContext` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª, –Ω–µ –ª–æ–º–∞–µ—Ç –∫–æ–¥)
2. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `DynRenderObject` trait (breaking change, –∫–æ–¥ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è)
3. üîÑ –û–±–Ω–æ–≤–∏—Ç—å **–í–°–ï** impl –±–ª–æ–∫–∏ (–ø–æ–∫–∞ –≤—Å–µ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã, –∫–æ–¥ –Ω–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è)
4. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `PipelineOwner`
5. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
7. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

## –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

### –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤—Å–µ—Ö impl –±–ª–æ–∫–æ–≤:

```bash
#!/bin/bash
# find_render_impls.sh

echo "Finding all DynRenderObject implementations..."
rg "impl.*DynRenderObject\s+for\s+(\w+)" --type rust -o -r '$1' | sort | uniq

echo -e "\nFiles to update:"
rg "impl.*DynRenderObject" --type rust -l
```

### Checklist –¥–ª—è –∫–∞–∂–¥–æ–≥–æ impl –±–ª–æ–∫–∞:

```markdown
- [ ] RenderText
- [ ] RenderFlex
- [ ] RenderPadding
- [ ] RenderOpacity
- [ ] RenderTransform
- [ ] RenderClipRect
- [ ] ... (–¥–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ)
```

## –í—Ä–µ–º—è –æ—Ü–µ–Ω–∫–∞

- –®–∞–≥ 1 (RenderContext): 15 –º–∏–Ω—É—Ç
- –®–∞–≥ 2 (DynRenderObject trait): 10 –º–∏–Ω—É—Ç
- –®–∞–≥ 3 (–≤—Å–µ impl –±–ª–æ–∫–∏): 2-3 —á–∞—Å–∞ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)
- –®–∞–≥ 4 (PipelineOwner): 30 –º–∏–Ω—É—Ç
- –®–∞–≥ 5 (—Ç–µ—Å—Ç—ã): 1 —á–∞—Å
- –®–∞–≥ 6 (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è): 30 –º–∏–Ω—É—Ç

**–ò—Ç–æ–≥–æ: 4-5 —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã**

## –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

‚úÖ RenderFlex –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –¥–µ—Ç—è–º —á–µ—Ä–µ–∑ context  
‚úÖ –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑ —Ö–∞–∫–æ–≤  
‚úÖ –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å (–ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ RenderContext)  
‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å (–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å mock context)  

–ì–æ—Ç–æ–≤–æ –∫ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É —Ä–∞–∑–≤–∏—Ç–∏—é! üéâ
