# –ò—Ç–æ–≥–æ–≤–∞—è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –†–µ—à–µ–Ω–∏–µ

## –ü—Ä–æ–±–ª–µ–º–∞ (–∫—Ä–∞—Ç–∫–æ)

```
MultiChildRenderObjectElement.children = Vec<ElementId> ‚úÖ
RenderFlex.children = Vec<FlexChild> ‚ùå (–ø—É—Å—Ç–æ)

RenderObject –ù–ï –ú–û–ñ–ï–¢ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥–µ—Ç—è–º!
```

## –†–µ—à–µ–Ω–∏—è (–∫—Ä–∞—Ç–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ)

### 1. Thread-local —Ö–∞–∫ ‚ùå
```rust
thread_local! { static TREE: ... }
```
- ‚ùå Unsafe, –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚ùå –ù–µ testable, –Ω–µ thread-safe
- ‚ùå –ê–Ω—Ç–∏-–ø–∞—Ç—Ç–µ—Ä–Ω –≤ Rust

### 2. RefCell –≤ ElementTree ‚ùå
```rust
elements: HashMap<ElementId, RefCell<...>>
```
- ‚ùå Runtime overhead
- ‚ùå –ú–æ–∂–µ—Ç panic
- ‚ùå –ù–µ thread-safe (–∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å RwLock)

### 3. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚ùå
```rust
render_flex.children = clone_children();
```
- ‚ùå –ù–ï–í–û–ó–ú–û–ñ–ù–û: Box<dyn Trait> –Ω–µ Clone

### 4. Two-pass layout (–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ö–∞–∫) ‚ö†Ô∏è
```rust
// Pass 1: layout –¥–µ—Ç–µ–π
// Pass 2: parent —á–∏—Ç–∞–µ—Ç —Ä–∞–∑–º–µ—Ä—ã
render_flex.layout_with_child_sizes(&sizes);
```
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ breaking changes
- ‚ö†Ô∏è –ù–µ —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ, –Ω–µ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ
- ‚ö†Ô∏è –í—Å—ë —Ä–∞–≤–Ω–æ –Ω—É–∂–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 5. RenderContext (–ü–†–ê–í–ò–õ–¨–ù–û) ‚úÖ
```rust
fn layout(&mut self, constraints: BoxConstraints, ctx: &RenderContext) -> Size
```
- ‚úÖ –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ Rust-idiomatic
- ‚úÖ –†–∞—Å—à–∏—Ä—è–µ–º–æ
- ‚úÖ Testable
- ‚ö†Ô∏è Breaking change

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

### –î–ª—è –ë–´–°–¢–†–û–ì–û –§–ò–ö–°–ê (1 —á–∞—Å):
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **Two-pass layout** —Å `layout_with_child_sizes()`:

```rust
// –í RenderFlex
pub fn layout_with_child_sizes(
    &mut self,
    constraints: BoxConstraints,
    child_sizes: &[Size],
) -> Size {
    // Layout logic —Å pre-computed —Ä–∞–∑–º–µ—Ä–∞–º–∏
}

// –í PipelineOwner
fn layout_element(&mut self, element_id: ElementId) {
    // 1. Layout –¥–µ—Ç–µ–π
    for child_id in children {
        self.layout_element(child_id);
    }
    
    // 2. –°–æ–±–∏—Ä–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã
    let sizes: Vec<Size> = children.iter()
        .map(|id| get_size(*id))
        .collect();
    
    // 3. Layout parent
    render_flex.layout_with_child_sizes(constraints, &sizes);
}
```

**–ü–ª—é—Å—ã:** –†–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å, –Ω–µ –ª–æ–º–∞–µ—Ç –∫–æ–¥  
**–ú–∏–Ω—É—Å—ã:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥

### –î–ª—è –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –†–ï–®–ï–ù–ò–Ø (4-5 —á–∞—Å–æ–≤):
–†–µ–∞–ª–∏–∑—É–π—Ç–µ **RenderContext –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É**:

1. –°–æ–∑–¥–∞–π—Ç–µ `RenderContext` struct
2. –û–±–Ω–æ–≤–∏—Ç–µ `DynRenderObject` trait
3. –ú–∏–≥—Ä–∏—Ä—É–π—Ç–µ –≤—Å–µ impl –±–ª–æ–∫–∏
4. Profit!

**–ü–ª—é—Å—ã:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞–≤—Å–µ–≥–¥–∞  
**–ú–∏–Ω—É—Å—ã:** Breaking change, —Ç—Ä–µ–±—É–µ—Ç –≤—Ä–µ–º–µ–Ω–∏

## –ü–ª–∞–Ω –î–µ–π—Å—Ç–≤–∏–π

### –≠—Ç–∞–ø 1: –ë—ã—Å—Ç—Ä—ã–π —Ñ–∏–∫—Å (—Å–µ–≥–æ–¥–Ω—è)
```bash
# –í—Ä–µ–º—è: 1 —á–∞—Å
1. –î–æ–±–∞–≤–∏—Ç—å layout_with_child_sizes() –≤ RenderFlex
2. –û–±–Ω–æ–≤–∏—Ç—å PipelineOwner::flush_layout()
3. –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç ‚úÖ
```

### –≠—Ç–∞–ø 2: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≤—Ä–µ–º—è)
```bash
# –í—Ä–µ–º—è: 4-5 —á–∞—Å–æ–≤
1. –°–æ–∑–¥–∞—Ç—å RenderContext (15 –º–∏–Ω)
2. –û–±–Ω–æ–≤–∏—Ç—å DynRenderObject trait (10 –º–∏–Ω)
3. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ impl –±–ª–æ–∫–∏ (2-3 —á–∞—Å–∞)
4. –û–±–Ω–æ–≤–∏—Ç—å PipelineOwner (30 –º–∏–Ω)
5. –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã (1 —á–∞—Å)
6. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (30 –º–∏–Ω)
```

## –ú–æ–π –°–æ–≤–µ—Ç

**–ï—Å–ª–∏ —ç—Ç–æ pet project / learning:** –î–µ–ª–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ä–∞–∑—É - RenderContext.  
**–ï—Å–ª–∏ —ç—Ç–æ production / deadline:** –ë—ã—Å—Ç—Ä—ã–π —Ñ–∏–∫—Å —Å–µ–π—á–∞—Å, —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Ç–æ–º.

–ù–æ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ, **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ thread-local —Ö–∞–∫–∏**. –≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –±–æ–ª—å—à–µ –ø—Ä–æ–±–ª–µ–º —á–µ–º —Ä–µ—à–∏—Ç.

## –ß—Ç–æ –Ø –ë—ã –°–¥–µ–ª–∞–ª

1. ‚úÖ –°–Ω–∞—á–∞–ª–∞ –±—ã—Å—Ç—Ä—ã–π —Ñ–∏–∫—Å (`layout_with_child_sizes`)
2. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
3. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
   ```rust
   // TODO: Migrate to RenderContext architecture
   // See: docs/–ü–†–ê–í–ò–õ–¨–ù–ê–Ø_–ê–†–•–ò–¢–ï–ö–¢–£–†–ê.md
   ```
4. ‚úÖ –ü–æ—Ç–æ–º (–≤ –≤—ã—Ö–æ–¥–Ω—ã–µ?) —Å–¥–µ–ª–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é

## –§–∞–π–ª—ã —Å –î–µ—Ç–∞–ª—è–º–∏

üìÑ [–ü–†–ê–í–ò–õ–¨–ù–ê–Ø_–ê–†–•–ò–¢–ï–ö–¢–£–†–ê.md](./–ü–†–ê–í–ò–õ–¨–ù–ê–Ø_–ê–†–•–ò–¢–ï–ö–¢–£–†–ê.md) - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ RenderContext  
üìÑ [–°–†–ê–í–ù–ï–ù–ò–ï_–ê–†–•–ò–¢–ï–ö–¢–£–†.md](./–°–†–ê–í–ù–ï–ù–ò–ï_–ê–†–•–ò–¢–ï–ö–¢–£–†.md) - –í–∏–∑—É–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤  
üìÑ [–ü–õ–ê–ù_–ú–ò–ì–†–ê–¶–ò–ò.md](./–ü–õ–ê–ù_–ú–ò–ì–†–ê–¶–ò–ò.md) - –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Å –∫–æ–¥–æ–º  
üìÑ [–ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ï_–†–ï–®–ï–ù–ò–ï.md](./–ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ï_–†–ï–®–ï–ù–ò–ï.md) - –ë—ã—Å—Ç—Ä—ã–π —Ñ–∏–∫—Å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø—É—Ç–∏ —Å–ø—Ä–∞—à–∏–≤–∞—è –ø—Ä–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ! 

**RenderContext - —ç—Ç–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ.**

–ù–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∏–∫—Å —Å `layout_with_child_sizes()` –∏ –º–∏–≥—Ä–∏—Ä—É–π—Ç–µ –ø–æ–∑–∂–µ.

–ì–ª–∞–≤–Ω–æ–µ - **–ù–ï –¥–µ–ª–∞—Ç—å thread-local —Ö–∞–∫–∏**! üôè

---

P.S. –ï—Å–ª–∏ –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º impl –±–ª–æ–∫–æ–º - –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å! –Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å –∫–æ–¥–æ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ RenderObject.
